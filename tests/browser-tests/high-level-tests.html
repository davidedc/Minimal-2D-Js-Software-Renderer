<!DOCTYPE html>
<html>
<head>
  <title>High-Level Tests - Software Canvas vs HTML5 Canvas</title>
  <link rel="stylesheet" href="styles/main.css">
</head>
<body>
  <!-- Core Libs and Polyfills -->
  <script src="../../src/canvas-sw-polyfills.js"></script>
  <script src="test-utils/test-registration-utils.js"></script>
  
  <!-- Utilities -->
  <script src="../../src/utils/canvas-extensions.js"></script>
  <script src="../../src/utils/geometry.js"></script>
  <script src="../../src/utils/PixelSet.js"></script>
  <script src="../../src/utils/random-utils.js"></script>
  <script src="../../src/utils/ScanlineSpans.js"></script>
  <script src="../../src/scene-creation/SeededRandom.js"></script>
  <script src="../../src/scene-creation/scene-creation-utils.js"></script>
  <script src="../../src/scene-creation/scene-creation-lines.js"></script>
  <script src="../../src/scene-creation/scene-creation-rects.js"></script>
  <script src="../../src/scene-creation/scene-creation-rounded-rects.js"></script>
  <script src="../../src/scene-creation/scene-creation-circles.js"></script>
  <script src="../../src/scene-creation/scene-creation-arcs.js"></script>

  <!-- Crisp SW Canvas Implementation (Needed for runCanvasCode) -->
  <script src="../../src/crisp-sw-canvas/color-utils.js"></script>
  <script src="../../src/crisp-sw-canvas/ContextState.js"></script>
  <script src="../../src/crisp-sw-canvas/CrispSwCanvas.js"></script>
  <script src="../../src/crisp-sw-canvas/CrispSwContext.js"></script>
  <script src="../../src/crisp-sw-canvas/transform-utils.js"></script>
  <script src="../../src/crisp-sw-canvas/TransformationMatrix.js"></script>

  <!-- SW Renderer Implementation (Needed by CrispSwContext and RenderTest) -->
  <script src="../../src/renderers/renderer-utils.js"></script>
  <script src="../../src/renderers/sw-renderer/SWRendererPixel.js"></script>
  <script src="../../src/renderers/sw-renderer/SWRendererArc.js"></script>
  <script src="../../src/renderers/sw-renderer/SWRendererCircle.js"></script>
  <script src="../../src/renderers/sw-renderer/SWRendererLine.js"></script>
  <script src="../../src/renderers/sw-renderer/SWRendererRect.js"></script>
  <script src="../../src/renderers/sw-renderer/SWRendererRoundedRect.js"></script>

  <!-- Canvas Renderer Implementation (Needed by RenderTest for comparison) -->
  <script src="../../src/renderers/canvas-renderer/canvas-arc.js"></script>
  <script src="../../src/renderers/canvas-renderer/canvas-circle.js"></script>
  <script src="../../src/renderers/canvas-renderer/canvas-line.js"></script>
  <script src="../../src/renderers/canvas-renderer/canvas-rect.js"></script>
  <script src="../../src/renderers/canvas-renderer/canvas-rounded-rect.js"></script>

  <!-- Test Framework Core -->
  <script src="../../src/RenderChecks.js"></script>
  <script src="../../src/RenderTest.js"></script>
  <script src="../../src/RenderTestBuilder.js"></script>

  <!-- Load Individual High-Level Test Files -->
  <!-- Each file contains drawing logic, definition, and self-registers the test -->
  <script src="test-cases/line-sgl-szMix-fNone-sOpaq-sw1px-lytCenter-edgeCrisp-ornHoriz-test.js"></script>
  <script src="test-cases/line-sgl-szMix-fNone-sOpaq-sw1px-lytCenter-edgeCrisp-ornVert-test.js"></script>
  <script src="test-cases/line-sgl-szMix-fNone-sOpaq-sw2px-lytCenter-edgeCrisp-ornHoriz-test.js"></script>
  <script src="test-cases/line-sgl-szMix-fNone-sOpaq-sw2px-lytCenter-edgeCrisp-ornVert-test.js"></script>
  <script src="test-cases/line-m20-szMix-fNone-sOpaq-sw1px-lytSpread-edgeNotCrisp-ornRand-test.js"></script>
  <script src="test-cases/line-m20-szMix-fNone-sOpaq-sw2px-lytSpread-edgeNotCrisp-ornRand-test.js"></script>
  <script src="test-cases/line-m20-szMix-fNone-sOpaq-sw3px-lytSpread-edgeNotCrisp-ornRand-test.js"></script>
  <script src="test-cases/line-m20-szMix-fNone-sOpaq-sw5px-lytSpread-edgeNotCrisp-ornRand-test.js"></script>
  <script src="test-cases/line-m20-szMix-fNone-sOpaq-sw10px-lytSpread-edgeNotCrisp-ornRand-test.js"></script>
  <script src="test-cases/line-m15-szMix-fNone-sMix-sw1-10px-lytSpread-edgeNotCrisp-ornRand-test.js"></script>
  <!-- Test cases for Rectangles -->
  <script src="test-cases/rect-sgl-szMix-fNone-sOpaq-sw1px-lytCenter-cenGrid-edgeCrisp-ornAxial-test.js"></script>
  <script src="test-cases/rect-sgl-szMix-fNone-sOpaq-sw1px-lytCenter-cenPx-edgeCrisp-ornAxial-test.js"></script>
  <script src="test-cases/rect-sgl-szMix-fSemi-sMix-swMix-lytRand-cenMixPG-edgeCrisp-ornAxial-test.js"></script>
  <script src="test-cases/rect-m10-szMix-fSemi-sMix-swMix-lytSpread-cenMixPG-edgeCrisp-ornAxial-test.js"></script>
  <script src="test-cases/rect-m5-szMix-fSemi-sMix-sw1-10px-lytSpread-cenRand-edgeNotCrisp-ornRand-ctxTransRand-ctxRotRand-test.js"></script>
  <!-- Rounded Rectangle Test Cases -->
  <script src="test-cases/roundrect-sgl-szMix-fNone-sOpaq-sw1px-lytCenter-cenGrid-edgeCrisp-ornAxial-rrrRand-test.js"></script>
  <script src="test-cases/roundrect-sgl-szMix-fNone-sOpaq-sw1px-lytCenter-cenPx-edgeCrisp-ornAxial-rrrRand-test.js"></script>
  <script src="test-cases/roundrect-sgl-szMix-fSemi-sOpaq-sw1-11px-lytCenter-cenGrid-edgeCrisp-ornAxial-rrrRand-test.js"></script>
  <script src="test-cases/roundrect-sgl-szMix-fSemi-sSemi-swMix-lytCenter-cenMixPG-edgeCrisp-ornAxial-rrrRand-test.js"></script>
  <script src="test-cases/roundrect-m10-szMix-fSemi-sOpaq-sw1px-lytSpread-cenMixPG-edgeCrisp-ornAxial-rrrRand-test.js"></script>
  <script src="test-cases/roundrect-m8-szMix-fSemi-sMix-swMix-lytSpread-cenMixPG-edgeCrisp-ornAxial-rrrMix-test.js"></script>
  <script src="test-cases/roundrect-m6-szMix-fSemi-sSemi-swMix-lytSpread-cenMixPG-edgeCrisp-ornAxial-rrrLrg-test.js"></script>
  <script src="test-cases/roundrect-m8-xl-fSemi-sNone-lytSpread-cenGrid-edgeCrisp-ornAxial-rrrLrg-test.js"></script>

  <!-- Circle Test Cases -->
  <script src="test-cases/circle-sgl-szMix-fNone-sOpaq-sw1px-lytCenter-cenGrid-edgeCrisp-test.js"></script>
  <script src="test-cases/circle-sgl-szMix-fNone-sOpaq-sw1px-lytCenter-cenPx-edgeCrisp-test.js"></script>
  <script src="test-cases/circle-sgl-szMix-fOpaq-sOpaq-sw1-30px-lytCenter-cenMixPG-edgeCrisp-test.js"></script>
  <script src="test-cases/circle-sgl-szMix-fOpaq-sNone-lytCenter-cenMixPG-edgeCrisp-test.js"></script>
  <script src="test-cases/circle-sgl-szMix-fOpaq-sOpaq-sw1-30px-lytRand-cenRand-edgeCrisp-test.js"></script>
  <script src="test-cases/circle-sgl-szMix-fOpaq-sNone-lytRand-cenRand-edgeCrisp-test.js"></script>
  <script src="test-cases/circle-m12-szMix-fSemi-sMix-sw1-4px-lytSpread-cenRand-edgeCrisp-test.js"></script>
  <script src="test-cases/circle-m12-szMix-fOpaq-sNone-lytSpread-cenRand-edgeCrisp-test.js"></script>
  <script src="test-cases/circle-sgl-szMix-fOpaq-sOpaq-sw1-10px-lytRand-cenRand-edgeNotCrisp-test.js"></script>
  <script src="test-cases/circle-m8-szMix-fOpaq-sOpaq-sw1-10px-lytSpread-cenRand-edgeNotCrisp-test.js"></script>

  <!-- Arc Test Cases -->
  <script src="test-cases/arc-m5-szMix-fOpaq-sOpaq-sw1-10px-lytSpread-cenRand-edgeNotCrisp-ornRand-arcARand-test.js"></script>
  <script src="test-cases/arc-m12-szMix-fNone-sOpaq-swMix-lytGrid-cenGrid-edgeNotCrisp-ornHoriz-arcADeg90-test.js"></script>

  <!-- Scene Test Cases -->
  <script src="test-cases/scene-multi-szMix-fMix-sMix-swMix-lytMix-edgeMix-ornMix-arcAMix-rrrMix-ctxTransFixed-ctxRotFixed-test.js"></script>

  <!-- Script to Load Tests and Init Page -->
  <script>
    // Test filename parser based on the naming convention
    class TestNameParser {
      constructor() {
        // Mapping from abbreviations to full names
        this.facetMappings = {
          // Shape
          'line': 'Line',
          'circle': 'Circle', 
          'rect': 'Rectangle',
          'roundrect': 'Rounded Rectangle',
          'arc': 'Arc',
          'scene': 'Scene',
          'mixshape': 'Mixed Shapes',
          
          // Count
          'sgl': 'Single',
          'multi': 'Multiple',
          
          // Size
          'xs': 'Extra Small (5-15px)',
          's': 'Small (16-39px)', 
          'm': 'Medium (40-79px)',
          'l': 'Large (80-159px)',
          'xl': 'Extra Large (160-400px)',
          'szMix': 'Mixed Sizes',
          
          // Fill Style
          'fNone': 'No Fill',
          'fOpaq': 'Opaque Fill',
          'fSemi': 'Semitransparent Fill',
          'fMix': 'Mixed Fill',
          
          // Stroke Style  
          'sNone': 'No Stroke',
          'sOpaq': 'Opaque Stroke',
          'sSemi': 'Semitransparent Stroke',
          'sMix': 'Mixed Stroke',
          
          // Layout
          'lytSpread': 'Spread Layout',
          'lytGrid': 'Grid Layout', 
          'lytRand': 'Random Layout',
          'lytCenter': 'Centered Layout',
          'lytMix': 'Mixed Layout',
          
          // Centered At
          'cenPx': 'Pixel-Centered',
          'cenGrid': 'Grid-Centered',
          'cenMixPG': 'Mixed Pixel/Grid-Centered',
          'cenRand': 'Random-Centered',
          
          // Edge Alignment
          'edgeCrisp': 'Crisp Edges',
          'edgeNotCrisp': 'Non-Crisp Edges',
          'edgeMix': 'Mixed Edge Alignment',
          
          // Orientation
          'ornHoriz': 'Horizontal',
          'ornVert': 'Vertical', 
          'ornAxial': 'Axis-Aligned',
          'ornDeg45': '45-Degree',
          'ornRand': 'Random Orientation',
          'ornMix': 'Mixed Orientation',
          
          // Arc Angle Extent
          'arcADeg90': '90-Degree Arc',
          'arcARand': 'Random Arc Angle',
          'arcAMix': 'Mixed Arc Angles',
          
          // Round Rect Radius
          'rrrLrg': 'Large Radius',
          'rrrRand': 'Random Radius',
          'rrrMix': 'Mixed Radius',
          
          // Context Transformations
          'ctxTransFixed': 'Fixed Translation',
          'ctxTransRand': 'Random Translation',
          'ctxRotFixed': 'Fixed Rotation',
          'ctxRotRand': 'Random Rotation', 
          'ctxScaleFixed': 'Fixed Scaling',
          'ctxScaleRand': 'Random Scaling',
          
          // Clipping
          'clpOnCirc': 'Circle',
          'clpOnArc': 'Arc',
          'clpOnRect': 'Rectangle',
          'clpOnRoundRect': 'Rounded Rectangle',
          'clpCt1': 'Single',
          'clpCtN': 'Multiple',
          'clpArrCenter': 'Centered',
          'clpArrRand': 'Random',
          'clpArrGrid': 'Grid', 
          'clpArrSpread': 'Spread',
          'clpSzXs': 'Extra Small (5-15px)',
          'clpSzS': 'Small (16-39px)',
          'clpSzM': 'Medium (40-79px)',
          'clpSzL': 'Large (80-159px)',
          'clpSzXl': 'Extra Large (160-400px)',
          'clpSzMix': 'Mixed Sizes',
          'clpEdgeCrisp': 'Crisp',
          'clpEdgeNotCrisp': 'Non-Crisp'
        };
        
        // Facet categories in order
        this.facetOrder = [
          'Shape', 'Count', 'Size', 'Fill Style', 'Stroke Style', 'Stroke Thickness',
          'Layout', 'Centered At', 'Edge Alignment', 'Orientation', 'Arc Angle', 
          'Round Rect Radius', 'Context Translation', 'Context Rotation', 'Context Scaling',
          'Clipping'
        ];
      }
      
      parseTestName(filename) {
        // Remove .js extension and split by dashes
        const nameWithoutExt = filename.replace(/\.js$/, '');
        const parts = nameWithoutExt.split('-');
        
        // Remove 'test' from the end
        if (parts[parts.length - 1] === 'test') {
          parts.pop();
        }
        
        const facets = {};
        let i = 0;
        
        // Initialize all facets to N/A first
        facets['Shape'] = 'N/A';
        facets['Count'] = 'N/A';
        facets['Size'] = 'N/A';
        facets['Fill Style'] = 'N/A';
        facets['Stroke Style'] = 'N/A';
        facets['Stroke Thickness'] = 'N/A';
        facets['Layout'] = 'N/A';
        facets['Centered At'] = 'N/A';
        facets['Edge Alignment'] = 'N/A';
        facets['Orientation'] = 'N/A';
        facets['Arc Angle'] = 'N/A';
        facets['Round Rect Radius'] = 'N/A';
        facets['Context Translation'] = 'N/A';
        facets['Context Rotation'] = 'N/A';
        facets['Context Scaling'] = 'N/A';
        facets['Clip Shape'] = 'N/A';
        facets['Clip Count'] = 'N/A';
        facets['Clip Arrangement'] = 'N/A';
        facets['Clip Size'] = 'N/A';
        facets['Clip Edge Alignment'] = 'N/A';
        
        // Parse in expected order
        if (i < parts.length) {
          facets['Shape'] = this.mapValue(parts[i++]);
        }
        
        if (i < parts.length) {
          // Handle count (sgl, multi, m[N])
          const countPart = parts[i++];
          if (countPart.startsWith('m') && /^\d+$/.test(countPart.substring(1))) {
            facets['Count'] = `Multi-${countPart.substring(1)}`;
          } else {
            facets['Count'] = this.mapValue(countPart);
          }
        }
        
        if (i < parts.length) {
          facets['Size'] = this.mapValue(parts[i++]);
        }
        
        if (i < parts.length && parts[i].startsWith('f')) {
          facets['Fill Style'] = this.mapValue(parts[i++]);
        }
        
        if (i < parts.length && parts[i].startsWith('s')) {
          facets['Stroke Style'] = this.mapValue(parts[i++]);
        }
        
        if (i < parts.length && parts[i].startsWith('sw')) {
          const strokePart = parts[i++];
          // Handle stroke thickness (sw1px, sw1-10px, swMix)
          if (strokePart === 'swMix') {
            facets['Stroke Thickness'] = 'Mixed Thickness';
          } else {
            facets['Stroke Thickness'] = strokePart.replace('sw', '') + (strokePart.includes('px') ? '' : ' pixels');
          }
        }
        
        // Parse remaining parts by prefix
        while (i < parts.length) {
          const part = parts[i++];
          
          if (part.startsWith('lyt')) {
            facets['Layout'] = this.mapValue(part);
          } else if (part.startsWith('cen')) {
            facets['Centered At'] = this.mapValue(part);
          } else if (part.startsWith('edge')) {
            facets['Edge Alignment'] = this.mapValue(part);
          } else if (part.startsWith('orn')) {
            facets['Orientation'] = this.mapValue(part);
          } else if (part.startsWith('arcA')) {
            facets['Arc Angle'] = this.mapValue(part);
          } else if (part.startsWith('rrr')) {
            // Handle rrrFix[N] pattern
            if (part.startsWith('rrrFix') && /^\d+$/.test(part.substring(6))) {
              facets['Round Rect Radius'] = `Fixed ${part.substring(6)}px`;
            } else {
              facets['Round Rect Radius'] = this.mapValue(part);
            }
          } else if (part.startsWith('ctxTrans')) {
            facets['Context Translation'] = this.mapValue(part);
          } else if (part.startsWith('ctxRot')) {
            facets['Context Rotation'] = this.mapValue(part);
          } else if (part.startsWith('ctxScale')) {
            facets['Context Scaling'] = this.mapValue(part);
          } else if (part.startsWith('clpOn')) {
            facets['Clip Shape'] = this.mapValue(part);
          } else if (part.startsWith('clpCt')) {
            facets['Clip Count'] = this.mapValue(part);
          } else if (part.startsWith('clpArr')) {
            facets['Clip Arrangement'] = this.mapValue(part);
          } else if (part.startsWith('clpSz')) {
            facets['Clip Size'] = this.mapValue(part);
          } else if (part.startsWith('clpEdge')) {
            facets['Clip Edge Alignment'] = this.mapValue(part);
          }
        }
        
        return facets;
      }
      
      mapValue(value) {
        return this.facetMappings[value] || value;
      }
      
      formatFacets(facets) {
        const themes = {
          'Shape & Basic': ['Shape', 'Count', 'Size', 'Orientation'],
          'Fill & Stroke': ['Fill Style', 'Stroke Style', 'Stroke Thickness'],
          'Layout & Position': ['Layout', 'Centered At', 'Edge Alignment'],
          'Shape-Specific': ['Arc Angle', 'Round Rect Radius'],
          'Context Transforms': ['Context Translation', 'Context Rotation', 'Context Scaling'],
          'Clipping': ['Clip Shape', 'Clip Count', 'Clip Arrangement', 'Clip Size', 'Clip Edge Alignment']
        };
        
        let html = '<div class="test-facets" style="margin-top: 10px; font-size: 11px; color: #666; border-top: 1px solid #eee; padding-top: 8px;">';
        html += '<div style="display: flex; flex-wrap: wrap; gap: 15px;">';
        
        for (const [themeName, facetNames] of Object.entries(themes)) {
          // Check if any facets in this theme have non-N/A values
          const hasRelevantFacets = facetNames.some(name => {
            const value = facets[name];
            return value !== 'N/A' && value !== '' && value !== null && value !== undefined;
          });
          
          // Always show all themes, even if all N/A
          html += '<div style="flex: 1; min-width: 140px; margin-bottom: 10px;">';
          html += `<div style="font-weight: bold; color: #444; margin-bottom: 4px; font-size: 12px;">${themeName}</div>`;
          
          for (const facetName of facetNames) {
            const value = facets[facetName];
            if (value !== undefined) {
              const displayValue = Array.isArray(value) ? value.join(', ') : value;
              html += `<div style="margin: 1px 0;"><strong>${facetName}:</strong> ${displayValue}</div>`;
            }
          }
          
          html += '</div>';
        }
        
        html += '</div></div>';
        return html;
      }
    }
    
    // Initialize parser
    const testNameParser = new TestNameParser();
    
    // Store original createNavigation to extend it
    const originalCreateNavigation = RenderTest.createNavigation;
    
    // Override createNavigation to add facet parsing
    RenderTest.createNavigation = function(title) {
      // Call original method
      const result = originalCreateNavigation.call(this, title);
      
      // Add facet information to each test
      Object.values(RenderTest.registry).forEach(test => {
        // Try different ID formats
        const possibleIds = [
          `test-${test.id}`,
          `test-${test.id.replace('.js', '')}`,
          test.id,
          test.id.replace('.js', '')
        ];
        
        let testElement = null;
        
        for (const id of possibleIds) {
          testElement = document.getElementById(id);
          if (testElement) {
            break;
          }
        }
        
        if (testElement && test.id) {
          // Find the description element 
          const descElement = testElement.querySelector('.test-description');
          
          if (descElement) {
            // Parse the test filename and add facet information
            const filename = test.id; // Use test.id directly since it already includes .js
            const facets = testNameParser.parseTestName(filename);
            const facetHtml = testNameParser.formatFacets(facets);
            descElement.insertAdjacentHTML('afterend', facetHtml);
          }
        }
      });
      
      return result;
    };

    document.addEventListener('DOMContentLoaded', () => {
      // Create navigation after all sections are added
      RenderTest.createNavigation("High-Level Tests");
    });
  </script>

</body>
</html> 